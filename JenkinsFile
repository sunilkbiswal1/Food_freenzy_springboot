pipeline {
    agent any 

    environment {
        SONAR_URL = "http://192.168.0.110"
        DOCKER_IMAGE = "foodfrenzyapp"
        DOCKER_REGISTRY = "sunilkumar45"
        DOCKER_TAG = "${BUILD_NUMBER}"
        DOCKER_CREDENTIALS = credentials('docker-cred')
        IMG = "Pipeline Started"
        BUILD_STATUS = "UNKNOWN"
        GIT_REPONAME = "Food_freenzy_springboot"
        GIT_USERNAME = "sunilkbiswal1"
    }
    stages {
        stage('Git Checkout') {
            steps {
                echo "================ Clonning GitHub ================"
                git branch: 'main',
                  url: 'https://github.com/sunilkbiswal1/Food_freenzy_springboot.git'
            }
        }

        stage('Verify Tools') {
            steps {
                echo "=================== TOOLS USED ===================="
                sh '''
                    mvn --version
                    git --version
                    java --version
                    docker --version
                '''
            }
        }

        stage('Docker Compile') {
            steps {
                echo "==================== COMPILING SOURCE CODE ===================="
                sh 'mvn clean compile'
            }
            post {
                success {
                    echo "Compilation Succesful......."
                }
                failure {
                    echo "Compilation Failed...... Stopping "
                }
            }
        }

        stage('Unit Testing') {
            steps {
                echo "==================== UNIT TESTING ===================="
                sh 'mvn test'
            }
            post {
                always {
                    junit '**/target/surefire-reports/*.xml'
                }
                success {
                    echo "Unit Tests Passed......."
                }
                failure {
                    echo "Unit Tests Failed...... Stopping Pipeline"
                }
            }
        }

        stage('Build') {
            steps {
                echo "==================== BUILDING JAR ===================="
                sh 'mvn clean package -DskipTests'
            }
            post {
                success {
                    echo "Build Successful......."
                    archiveArtifacts artifacts: 'target/*.jar',
                        fingerprint: true,
                        allowEmptyArchive: false
                    script {
                        BUILD_STATUS="SUCCESS"
                    }
                }
                failure {
                    echo "Build Failed .............. Stopping Pipeline"
                    script {
                        BUILD_STATUS="FAILURE"
                    }
                }
            }
        }

        stage('Static Code Analysis') {
            steps {
                echo "=========================== CODE ANALYSIS THROUGH SONARQUBE =========================="

                withSonarQubeEnv('sonarqube-server') {
                    withCredentails([string(credentailsId: 'sonrqube', variable: 'SOAR_TOKEN')]) {
                        sh '''
                            mvn sonar:sonar \
                            -Dsonar.host.url=${SONAR_URL} \
                            -Dsonar.login=${SONAR_TOKEN} \
                            -Dsonar.ws.timeout=120 \
                            -Dsonar.plugins.downloadOnlyRequired=true
                        '''
                    }
                }
            }
            post {
                success {
                    echo "Quality  Gate Passed ...."
                }
                failure {
                    echo "Quality Gate Failed ... Stopping Pipeline"     
                }
            }
        }

        stage('Docker Build ') {
            steps {
                script {
                    echo "==================== DOCKER IMAGE BUILDING ===================="
                    sh '''
                        docker build -t ${DOCKER_REGISTRY}/${DOCKER_IMAGE}:${DOCKER_TAG} .
                        docker tag ${DOCKER_REGISTRY}/${DOCKER_IMAGE}:${DOCKER_TAG} ${DOCKER_REGISTRY}/${DOCKER_IMAGE}:latest
                    '''
                }
            }
            post {
                success {
                    echo "Docker Image Build Succesful........."
                }
                failure {
                    echo "Docker Image Build Failed ........ Stopping Pipeline!"
                }
            }
        }

        stage ('Docker Image Scanning') {
            steps {
                echo "==================== RUNNING TRIVY IMGE SCANNING VULNERBILITY ===================="
                sh '''
                    trivy image \
                    --severity HIGH,CRITICAL \
                    --exit-code 1\
                    --no-progress \
                    ${DOCKER_REGISTRY}/${DOCKER_IMAGE}:${DOCKER_TAG}
                '''
            }
            post {
                success {
                    echo "No Vulnerability Found.... Succesful!"
                }
                failure {
                    echo "Vulnerability Found ........ Piooeline failed!"
                }
            }
        }

        stage ('Docker Image Push') {
            steps {
                echo "==================== PUSHING DOCKER IMAGE TO REGISTRY ===================="
                script {
                    docker.withRegistry('https://index.docker.io/v1/', 'docker-cred') {
                    sh '''
                        docker push ${DOCKER_REGISTRY}/${DOCKER_IMAGE}:${DOCKER_TAG}
                        docker push ${DOCKER_REGISTRY}/${DOCKER_IMAGE}:latest
                    '''
                    }
                }
            }
            post {
                success {
                    echo "Docker Imaged Pushed to Docker Hub!"
                    script {
                        env.IMG = "${DOCKER_REGISTRY}/${DOCKER_IMAGE}:${DOCKER_TAG}"
                    }
                }
                failure {
                    echo "Docker Image Push Failed ........ Stopping Pipeline!"
                    script {
                        env.IMG="DOCKER IMAGE NOT PUSHED"
                    }
                }
            }
        }

        // stage('Update GitHub Status') {
        //     withCredentials([string(credentialsId: 'github', variable: 'GITHUB_TOKEN')]) {
        //         steps {
        //             echo "================= UPDATE GITHUB REPO STATUS ================="
        //             sh '''
        //                 cd /tmp
        //                 rm -rf ${GIT_REPONAME}

        //                 echo "Clonnig Repository ........"
        //                 git clone https://@{GITHUB_TOKEN}@github.com/${GIT_USERNAME}/${GIT_REPONAME}.git
        //                 cd ${GIT_REPONAME}

        //                 git config user.email "biswalpranati99@gmail.com"
        //                 git config user.name "sunilkbiswal1"

        //                 echo "Verify deployment file exist or not !"
        //                 if [! -f food-freenzy-helm/values.yaml]; then
        //                     sed -i "s/replaceImageTag/${BUILD_NUMBER}/g" food-freenzy-helm/values.yaml
        //                 else
        //                     echo "Error: food-freenzy-helm/values.yaml not found!"
        //                     exit 1
        //                 fi

        //                 echo "Updating app-deployment.yml in the manifest file ........."
        //                 sed -i "s/app.image.tag:.*/app.image.tag:/${BUILD_NUMBER}/g" food-freenzy-helm/values.yaml
        //                 cat food-freenzy-helm/values.yaml

        //                 echo "Add , Commit & Push .........."
        //                 git add food-freenzy-helm/values.yaml
        //                 git commit -m "Update image tag to ${BUILD_NUMBER} from Jenkins"
        //                 git push origin main
        //             '''
        //         }
        //     }
        //     post {
        //         success {
        //             echo "Succesfully pushed to the Github"
        //         }
        //         failure {
        //             echo "Failed to push to the Github!"
        //         }
        //     }
        // }
    }
}

post {
    success {
        echo "================= PIPELINE SUCCESFULL ================="
        echo "Build Status: ${BUILD_STATUS}"
        emailext(
                subject: "SUCCESS: ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                body: """
                <h2>Build Successful ðŸŽ‰</h2>
                <p><b>Job:</b> ${env.JOB_NAME}</p>
                <p><b>Build Number:</b> ${env.BUILD_NUMBER}</p>
                <p><b>Status:</b> ${currentBuild.currentResult}</p>
                <p><b>Message:</b> ${env.MSG}</p>
                <p><a href="${env.BUILD_URL}">View Build</a></p>
                <p><b>Docker Image:</b> sunilkbiswal1/foodfrenzyapp:${BUILD_NUMBER}</p>
                """,
                mimeType: 'text/html',
                to: 'biswalsk9206@gmail.com'
            )           
    }
    failure {
        echo "==================== PIPELINE FAILED ================="
        echo "TRY AGAIN !"
    }
}
